from typing import ClassVar

from django.test import TestCase

from ftso.models import FeedResult, RandomResult
from ftso.views import get_merkle_tree_for_round
from processing.utils import un_prefix_0x


class RoundFtsoMerkleTreeTestCase(TestCase):
    RESPONSE: ClassVar = {
        "status": "OK",
        "protocolId": 100,
        "votingRoundId": 667713,
        "merkleRoot": "0x61b9ce9257e1c596b9f51477c65ba75e43466b3e60e243ed205c91ea1de53db4",
        "isSecureRandom": True,
        "tree": [
            {
                "votingRoundId": 667713,
                "value": "0x4e5961cc8e1bb59e64d5190ae1fde439ef4e8153deb4434437dd76c43e59d20a",
                "isSecure": True,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01414156452f555344000000000000000000000000",
                "value": 851010,
                "turnoutBIPS": 0,
                "decimals": 4,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014144412f55534400000000000000000000000000",
                "value": 41253,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01414c474f2f555344000000000000000000000000",
                "value": 15132,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014150542f55534400000000000000000000000000",
                "value": 782680,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014152422f55534400000000000000000000000000",
                "value": 91506,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x0141544f4d2f555344000000000000000000000000",
                "value": 714648,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01415641582f555344000000000000000000000000",
                "value": 3035580,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014245414d2f555344000000000000000000000000",
                "value": 2004,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01424e422f55534400000000000000000000000000",
                "value": 6057132,
                "turnoutBIPS": 10000,
                "decimals": 4,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014254432f55534400000000000000000000000000",
                "value": 6623417,
                "turnoutBIPS": 10000,
                "decimals": 2,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01444f47452f555344000000000000000000000000",
                "value": 13611,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01444f542f55534400000000000000000000000000",
                "value": 620656,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014554432f55534400000000000000000000000000",
                "value": 2541792,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014554482f55534400000000000000000000000000",
                "value": 3560654,
                "turnoutBIPS": 10000,
                "decimals": 3,
            },
            {
                "votingRoundId": 667713,
                "id": "0x0146494c2f55534400000000000000000000000000",
                "value": 520007,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01464c522f55534400000000000000000000000000",
                "value": 2700,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x0147414c412f555344000000000000000000000000",
                "value": 3277,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014752542f55534400000000000000000000000000",
                "value": 23556,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01484241522f555344000000000000000000000000",
                "value": 8486,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014943502f55534400000000000000000000000000",
                "value": 915542,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01494d582f55534400000000000000000000000000",
                "value": 173107,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01494e4a2f55534400000000000000000000000000",
                "value": 2510200,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014c444f2f55534400000000000000000000000000",
                "value": 199808,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014c54432f55534400000000000000000000000000",
                "value": 7939810,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014d415449432f5553440000000000000000000000",
                "value": 61127,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014e4541522f555344000000000000000000000000",
                "value": 560737,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x014f502f5553440000000000000000000000000000",
                "value": 205873,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01514e542f55534400000000000000000000000000",
                "value": 829935,
                "turnoutBIPS": 0,
                "decimals": 4,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01524e44522f555344000000000000000000000000",
                "value": 795937,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015347422f55534400000000000000000000000000",
                "value": 920,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01534849422f555344000000000000000000000000",
                "value": 206534,
                "turnoutBIPS": 9999,
                "decimals": 10,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01534f4c2f55534400000000000000000000000000",
                "value": 1445083,
                "turnoutBIPS": 10000,
                "decimals": 4,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015354524b2f555344000000000000000000000000",
                "value": 93559,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015354582f55534400000000000000000000000000",
                "value": 192497,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015355492f55534400000000000000000000000000",
                "value": 94282,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015449412f55534400000000000000000000000000",
                "value": 773605,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015452582f55534400000000000000000000000000",
                "value": 11523,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01554e492f55534400000000000000000000000000",
                "value": 1148311,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01555344432f555344000000000000000000000000",
                "value": 100031,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01555344542f555344000000000000000000000000",
                "value": 99967,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015645542f55534400000000000000000000000000",
                "value": 2865,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015844432f55534400000000000000000000000000",
                "value": 3398,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x01584c4d2f55534400000000000000000000000000",
                "value": 9771,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x015852502f55534400000000000000000000000000",
                "value": 48849,
                "turnoutBIPS": 10000,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x0158545a2f55534400000000000000000000000000",
                "value": 1000,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x024155442f55534400000000000000000000000000",
                "value": 1000,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x024555522f55534400000000000000000000000000",
                "value": 106961,
                "turnoutBIPS": 9999,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x024a50592f55534400000000000000000000000000",
                "value": 1000,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x035841472f55534400000000000000000000000000",
                "value": 1000,
                "turnoutBIPS": 0,
                "decimals": 5,
            },
            {
                "votingRoundId": 667713,
                "id": "0x035841552f55534400000000000000000000000000",
                "value": 10,
                "turnoutBIPS": 0,
                "decimals": 3,
            },
            {
                "votingRoundId": 667713,
                "id": "0x035850542f55534400000000000000000000000000",
                "value": 100,
                "turnoutBIPS": 0,
                "decimals": 4,
            },
        ],
    }

    def setUp(self):
        tree_elements = self.RESPONSE.get("tree")
        random_element = tree_elements[0]
        RandomResult.objects.create(
            voting_round_id=random_element.get("votingRoundId"),
            value=un_prefix_0x(random_element.get("value")),
            is_secure=random_element.get("isSecure"),
        )
        for element in tree_elements[1:]:
            FeedResult.objects.create(
                voting_round_id=element.get("votingRoundId"),
                feed_id=un_prefix_0x(element.get("id")),
                value=element.get("value"),
                turnout_bips=element.get("turnoutBIPS"),
                decimals=element.get("decimals"),
            )

    def test_merkle_tree(self):
        tree = get_merkle_tree_for_round(667713)
        self.assertEqual(tree.root, self.RESPONSE.get("merkleRoot"))
